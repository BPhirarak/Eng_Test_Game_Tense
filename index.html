<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Grammar Catcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a202c;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            margin: 0 auto;
            background: linear-gradient(to bottom, #2d3748, #1a202c);
            overflow: hidden;
        }
        canvas {
            display: block;
            background: transparent;
        }
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .pointer-events-auto {
            pointer-events: auto;
        }
        /* Mobile Touch Controls */
        .touch-zone {
            position: absolute;
            bottom: 30px;
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            user-select: none;
            backdrop-filter: blur(4px);
            z-index: 100;
        }
        #left-ctrl { left: 20px; }
        #right-ctrl { right: 20px; }

        #reading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fbbf24;
            padding: 1.5rem;
            border-radius: 1rem;
            font-weight: bold;
            font-size: 1.2rem;
            display: none;
            z-index: 20;
            border: 3px solid #fbbf24;
            text-align: center;
            width: 85%;
            max-width: 350px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="reading-overlay">GET READY!</div>

    <!-- Controls -->
    <div id="left-ctrl" class="touch-zone pointer-events-auto md:hidden">‚¨ÖÔ∏è</div>
    <div id="right-ctrl" class="touch-zone pointer-events-auto md:hidden">‚û°Ô∏è</div>
    
    <!-- UI Layer -->
    <div class="ui-layer flex flex-col p-4">
        <div class="flex justify-between items-start text-white">
            <div class="bg-black/60 p-3 rounded-lg max-w-[65%] border border-white/20">
                <div id="question-text" class="text-sm md:text-lg font-bold leading-tight mb-2">Loading...</div>
                <div id="choices-container" class="grid grid-cols-1 md:grid-cols-2 gap-1 text-[10px] md:text-sm">
                    <div id="choice-a" class="flex items-center"><span class="w-5 h-5 rounded bg-red-500 inline-flex items-center justify-center mr-1 text-[10px]">A</span> <span class="text-label truncate">...</span></div>
                    <div id="choice-b" class="flex items-center"><span class="w-5 h-5 rounded bg-blue-500 inline-flex items-center justify-center mr-1 text-[10px]">B</span> <span class="text-label truncate">...</span></div>
                    <div id="choice-c" class="flex items-center"><span class="w-5 h-5 rounded bg-green-500 inline-flex items-center justify-center mr-1 text-[10px]">C</span> <span class="text-label truncate">...</span></div>
                    <div id="choice-d" class="flex items-center"><span class="w-5 h-5 rounded bg-yellow-500 inline-flex items-center justify-center mr-1 text-[10px]">D</span> <span class="text-label truncate">...</span></div>
                </div>
            </div>
            
            <div class="flex flex-col gap-1 items-end text-[10px] md:text-xs">
                <div class="bg-black/70 px-3 py-1 rounded-full border border-purple-500 text-purple-300 font-bold">LVL: <span id="lvl-val">1</span>/3</div>
                <div class="bg-black/70 px-3 py-1 rounded-full border border-yellow-500 text-yellow-400 font-bold">Score: <span id="score-val">0</span></div>
                <div class="bg-black/70 px-3 py-1 rounded-full border border-red-500 text-red-400 font-bold"><span id="game-timer">05:00</span></div>
                <div class="bg-black/70 px-3 py-1 rounded-full border border-blue-500 text-blue-400 font-bold">Q: <span id="q-count">0</span>/20</div>
            </div>
        </div>
        <div class="mt-2 w-full h-1.5 bg-gray-800 rounded-full overflow-hidden">
            <div id="q-timer-bar" class="h-full bg-green-500" style="width: 100%;"></div>
        </div>
    </div>

    <!-- Overlays -->
    <div id="start-screen" class="absolute inset-0 bg-black/95 flex items-center justify-center z-50 text-white p-6 text-center">
        <div class="max-w-md">
            <h1 class="text-4xl font-bold text-yellow-500 mb-2 italic">ENGLISH CATCHER</h1>
            <p class="text-blue-400 mb-6 font-semibold">Fun Grammar Challenge</p>
            <button onclick="startGame()" class="px-12 py-4 bg-blue-600 rounded-full text-2xl font-bold shadow-lg pointer-events-auto hover:bg-blue-500 transition-colors">PLAY NOW</button>
            <p class="mt-8 text-xs text-gray-400">TIPS: Catch balls with bucket. Wrong balls release peters!</p>
        </div>
    </div>

    <div id="level-screen" class="hidden absolute inset-0 bg-indigo-900/95 flex items-center justify-center z-50 text-white p-6 text-center">
        <div>
            <h1 class="text-5xl font-bold text-yellow-400 mb-4 italic">LEVEL COMPLETE!</h1>
            <p class="text-xl mb-8 font-light text-blue-200">Prepare for faster speed in Level <span id="next-lvl-name">2</span></p>
            <button onclick="startNextLevel()" class="px-14 py-4 bg-yellow-500 text-black rounded-full text-2xl font-bold pointer-events-auto hover:bg-yellow-400 transition-colors">READY</button>
        </div>
    </div>

    <div id="game-over-screen" class="hidden absolute inset-0 bg-black/95 flex items-center justify-center z-50 text-white p-6 text-center">
        <div>
            <h1 id="result-title" class="text-5xl font-bold mb-4 text-red-500">GAME OVER</h1>
            <div id="final-score" class="text-6xl font-bold text-yellow-500 mb-6">0 ü™ô</div>
            <button onclick="location.reload()" class="px-10 py-3 bg-green-600 rounded-full text-xl font-bold pointer-events-auto">TRY AGAIN</button>
        </div>
    </div>
</div>

<script>
    let audioCtx = null;
    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playSnd(freq, dur, type='triangle', slide=0) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = type; const now = audioCtx.currentTime;
        osc.frequency.setValueAtTime(freq, now);
        if(slide) osc.frequency.exponentialRampToValueAtTime(freq+slide, now+dur);
        gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + dur);
        osc.start(now); osc.stop(now + dur);
    }

    const questions = [
        { q: "Oh look! It ______ snow soon.", a: "is going to", b: "will", c: "are going to", d: "goes to", correct: "a" },
        { q: "Next summer I ______ backpack around Europe.", a: "is going to", b: "am going to", c: "will", d: "was going to", correct: "b" },
        { q: "Ring! Ring! I ______ answer it.", a: "will", b: "am going to", c: "is going to", d: "shall", correct: "a" },
        { q: "I think our team ______ win the match.", a: "will", b: "going to", c: "is going to", d: "am going to", correct: "a" },
        { q: "In 2055 robots ______ be our teachers.", a: "going to", b: "are going to", c: "will", d: "would", correct: "c" },
        { q: "Tonight we ______ have a birthday party.", a: "will", b: "are going to", c: "is going to", d: "shall", correct: "b" },
        { q: "Look at the clouds! It ______ soon.", a: "will rain", b: "is going to rain", c: "rains", d: "is raining", correct: "b" },
        { q: "Be careful! You ______ drop the dishes.", a: "will", b: "are going to", c: "go to", d: "drop", correct: "b" },
        { q: "I doubt that he ______ pass the test.", a: "will", b: "going to", c: "is going to", d: "passes", correct: "a" },
        { q: "I promise I ______ be careful.", a: "am going to", b: "will", c: "shall", d: "was", correct: "b" },
        { q: "Luis ______ (give) me a present.", a: "have gave", b: "has gave", c: "have given", d: "has given", correct: "d" },
        { q: "They ______ (not/buy) a computer yet.", a: "hasn't buy", b: "hasn't bought", c: "haven't buy", d: "haven't bought", correct: "d" },
        { q: "Sara ______ (forget) her money.", a: "has forget", b: "have forgot", c: "has forgotten", d: "has forgot", correct: "c" },
        { q: "They ______ each other for ten years.", a: "know", b: "knew", c: "have known", d: "has known", correct: "c" },
        { q: "My brother ______ his keys.", a: "lose", b: "lost", c: "have lost", d: "has lost", correct: "d" },
        { q: "I ______ here since 2015.", a: "live", b: "lived", c: "have lived", d: "has lived", correct: "c" },
        { q: "Watch out! You ______ fall!", a: "will", b: "are going to", c: "do", d: "go to", correct: "b" },
        { q: "Maybe it ______ sunny tomorrow.", a: "is going to be", b: "will be", c: "is", d: "be", correct: "b" },
        { q: "A: The phone is ringing. B: I ______ it!", a: "am going to answer", b: "will answer", c: "answer", d: "answering", correct: "b" },
        { q: "I hope Thailand ______ win the match.", a: "is going to", b: "will", c: "wins", d: "winning", correct: "b" }
    ];

    const lvls = [
        { speedMult: 0.5, label: "Level 1" },
        { speedMult: 0.9, label: "Level 2" },
        { speedMult: 1.4, label: "Level 3" }
    ];

    const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
    let active = false, score = 0, qIdx = 0, lvl = 1, gameTime = 300, qTime = 25;
    let waiting = false, waitT = 0, currentQ = null, peters = [], balls = [];
    const bucket = { width: 0, height: 0, x: 0, y: 0, speed: 0 };
    const keys = { Left: false, Right: false };

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // MOBILE OPTIMIZED BUCKET: 15% width on small screens, max 100px
        bucket.width = Math.min(100, canvas.width * 0.15);
        bucket.height = bucket.width * 0.6;
        bucket.y = canvas.height - 100;
        bucket.x = Math.max(0, Math.min(canvas.width - bucket.width, bucket.x));
        bucket.moveSpeed = canvas.width * 0.022; // Slightly tuned for control
    }
    window.addEventListener('resize', resize); resize();

    window.addEventListener('keydown', e => { if (e.key === 'ArrowLeft') keys.Left = true; if (e.key === 'ArrowRight') keys.Right = true; });
    window.addEventListener('keyup', e => { if (e.key === 'ArrowLeft') keys.Left = false; if (e.key === 'ArrowRight') keys.Right = false; });
    
    // Direct Screen Touch
    window.addEventListener('touchstart', e => {
        const x = e.touches[0].clientX;
        if (x < canvas.width / 2) keys.Left = true; else keys.Right = true;
    }, {passive: false});
    window.addEventListener('touchend', () => { keys.Left = false; keys.Right = false; });

    // Buttons
    const lBtn = document.getElementById('left-ctrl'), rBtn = document.getElementById('right-ctrl');
    lBtn.onmousedown = lBtn.ontouchstart = (e) => { e.stopPropagation(); keys.Left = true; };
    lBtn.onmouseup = lBtn.ontouchend = () => keys.Left = false;
    rBtn.onmousedown = rBtn.ontouchstart = (e) => { e.stopPropagation(); keys.Right = true; };
    rBtn.onmouseup = rBtn.ontouchend = () => keys.Right = false;

    function startGame() {
        initAudio(); document.getElementById('start-screen').style.display = 'none';
        active = true; score = 0; lvl = 1; gameTime = 300;
        startRound();
        requestAnimationFrame(loop);
        
        // Use a single timer reference to avoid duplicate intervals
        if (!window.gameIntervalsSet) {
            setInterval(() => { if (active) { gameTime--; updateUI(); if(gameTime<=0) end("TIME'S UP!"); }}, 1000);
            setInterval(() => { if (active && !waiting) { qTime -= 0.1; updateUI(); if(qTime<=0) miss(); }}, 100);
            window.gameIntervalsSet = true;
        }
    }

    function startRound() {
        qIdx = 0;
        selectedQs = [...questions].sort(() => 0.5-Math.random()).slice(0, 20);
        nextQ();
    }

    function startNextLevel() {
        document.getElementById('level-screen').classList.add('hidden');
        lvl++; 
        active = true; 
        startRound();
        requestAnimationFrame(loop); // RESTART THE LOOP HERE
    }

    function nextQ() {
        if (qIdx >= 20) {
            active = false;
            if (lvl < 3) {
                document.getElementById('level-screen').classList.remove('hidden');
                document.getElementById('next-lvl-name').innerText = lvl + 1;
            } else end("GRANDMASTER!");
            return;
        }
        currentQ = selectedQs[qIdx];
        balls = []; waiting = true; waitT = 4.0;
        document.getElementById('question-text').innerText = currentQ.q;
        ['a','b','c','d'].forEach(l => document.getElementById(`choice-${l}`).querySelector('.text-label').innerText = currentQ[l]);
        document.getElementById('reading-overlay').style.display = 'block';
        qIdx++; updateUI();
    }

    function spawn() {
        waiting = false; qTime = 25;
        document.getElementById('reading-overlay').style.display = 'none';
        const config = lvls[lvl-1];
        ['a','b','c','d'].forEach((l, i) => {
            balls.push({
                x: (canvas.width / 5) * (i + 1),
                y: -50 - (Math.random() * 120),
                r: Math.min(20, canvas.width * 0.045),
                choice: l, color: ['#ef4444','#3b82f6','#22c55e','#eab308'][i],
                speed: (canvas.height * 0.0016 + (Math.random() * 0.8)) * config.speedMult
            });
        });
    }

    function catchBall(b) {
        if (b.choice === currentQ.correct) { score += 10; playSnd(523, 0.2, 'triangle', 500); }
        else { playSnd(150, 0.3, 'sawtooth', -100); peters.push({x:Math.random()*canvas.width, y:canvas.height-30, vx:(Math.random()-0.5)*6}); }
        nextQ();
    }

    function miss() { playSnd(150, 0.3, 'sawtooth', -100); peters.push({x:Math.random()*canvas.width, y:canvas.height-30, vx:(Math.random()-0.5)*6}); nextQ(); }

    function updateUI() {
        document.getElementById('score-val').innerText = score;
        document.getElementById('q-count').innerText = qIdx;
        document.getElementById('lvl-val').innerText = lvl;
        const m = Math.floor(gameTime/60), s = Math.max(0, gameTime%60);
        document.getElementById('game-timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
        document.getElementById('q-timer-bar').style.width = waiting ? "100%" : (Math.max(0, qTime)/25*100) + "%";
        if (waiting) document.getElementById('reading-overlay').innerText = `LEVEL ${lvl}: READING... ${Math.ceil(waitT)}`;
    }

    function end(t) {
        active = false;
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('result-title').innerText = t;
        document.getElementById('final-score').innerText = score + " ü™ô";
    }

    function loop() {
        if (!active) return; // This is why the loop stops when active is false
        
        if (keys.Left) bucket.x -= bucket.moveSpeed;
        if (keys.Right) bucket.x += bucket.moveSpeed;
        bucket.x = Math.max(0, Math.min(canvas.width - bucket.width, bucket.x));

        if (waiting) {
            waitT -= 0.016;
            if (waitT <= 0) spawn();
        } else {
            for (let i = balls.length - 1; i >= 0; i--) {
                let b = balls[i];
                b.y += b.speed;
                if (b.y+b.r > bucket.y && b.y-b.r < bucket.y+bucket.height && b.x+b.r > bucket.x && b.x-b.r < bucket.x+bucket.width) {
                    catchBall(b);
                    break;
                } else if (b.y-b.r > canvas.height) { 
                    balls.splice(i,1); 
                    if(!balls.length) miss(); 
                }
            }
        }
        peters.forEach(p => { p.x += p.vx; if(p.x<0 || p.x>canvas.width) p.vx*=-1; });
        draw();
        requestAnimationFrame(loop);
    }

    function draw() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        // Bucket
        ctx.fillStyle = '#4a5568'; ctx.beginPath(); ctx.roundRect(bucket.x, bucket.y, bucket.width, bucket.height, 8); ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
        // Balls
        if (!waiting) {
            balls.forEach(b => {
                ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.font = `bold ${b.r}px Arial`; ctx.textAlign='center'; ctx.fillText(b.choice.toUpperCase(), b.x, b.y+b.r/3);
            });
        }
        // Peters
        peters.forEach(p => {
            ctx.font = '24px Arial'; ctx.save(); ctx.translate(p.x, p.y); if(p.vx<0) ctx.scale(-1,1); ctx.fillText('ü™≥', 0, 0); ctx.restore();
        });
    }
</script>
</body>
</html>
